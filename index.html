<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Draft Tool</title>
  <style>
    body { font-family: Arial, sans-serif; }
    #upload-container { margin: 20px 0; }
  </style>
</head>
<body>
  <!-- Upload only shows first time -->
  <div id="upload-container">
    <input type="file" id="csv-file" accept=".csv">
  </div>

  <!-- Search -->
  <input id="player-search" type="text" placeholder="Search players" disabled>

  <div id="results"></div>

  <script>
    let playersData = [];
    let results = [];
    let teamStatus = {};
    let selectedPlayer = null;

    // Dummy placeholders so code runs
    function parseCSV(text) {
  const lines = text.split(/\r?\n/).filter(l => l.trim() !== "");
  const headers = lines[0].split(",").map(h => h.trim());
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    let obj = {};
    headers.forEach((h, i) => {
      obj[h] = (cols[i] || "").trim();
    });
    return obj;
  });
}

function normalizeKeys() {
  playersData = playersData.map(row => {
    const newRow = {};
    for (let key in row) {
      const lower = key.toLowerCase();
      if (lower.includes("name") || lower.includes("player")) {
        newRow.Name = row[key];
      } else {
        newRow[key] = row[key];
      }
    }
    return newRow;
  });
}

function populatePlayerList(data) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";
  data.forEach(player => {
    const div = document.createElement("div");
    div.textContent = player.Name || "Unnamed";
    resultsDiv.appendChild(div);
  });
}
    function enableSearch() {}
    function updateNominations() {}
    function updateTop200Table() {}
    function updateResultsTable() {}
    function updateInflationChip(p) {}
    function updateTeamSummary() {}
    function historySetButtons() {}
    function initTeamData() {}
    function populateTeamsSelect() {}
    function handleSearch(e) {
  const q = e.target.value.toLowerCase();
  const filtered = playersData.filter(p =>
    (p.Name || "").toLowerCase().includes(q)
  );
  populatePlayerList(filtered);
}

    // ---------- CSV upload handler ----------
    document.getElementById('csv-file')?.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        setTimeout(() => {
          try {
            const csvText = e.target.result;
            playersData = parseCSV(csvText);
            normalizeKeys();

            if (!playersData || playersData.length === 0) {
              alert('Could not find any rows in that CSV. Make sure it has a Name/Player column.');
              return;
            }

            populatePlayerList(playersData);

            const search = document.getElementById('player-search');
            if (search) {
              search.disabled = false;
              search.removeAttribute('disabled');
              search.removeEventListener('input', handleSearch);
              search.addEventListener('input', handleSearch);
              setTimeout(() => search.focus(), 200);
            }

            localStorage.setItem('draftData', JSON.stringify(playersData));
            updateNominations();
            updateTop200Table();

            // Hide upload forever
            const up = document.getElementById('upload-container');
            if (up) up.style.display = 'none';

            alert('CSV loaded successfully.');
          } catch (err) {
            console.error(err);
            alert('Error parsing CSV');
          }
        }, 100);
      };
      reader.readAsText(file);
    });

    // ---------- On page load ----------
    window.addEventListener('load', () => {
      initTeamData();
      populateTeamsSelect();

      const stored = localStorage.getItem('draftResults');
      if (stored) {
        try {
          results = JSON.parse(stored);
          results.forEach(row => {
            const t = row.team;
            const b = parseFloat(row.bid);
            if (teamStatus[t]) {
              teamStatus[t].remaining -= b;
              teamStatus[t].picks += 1;
            }
          });
          updateResultsTable();
          updateInflationChip(selectedPlayer);
        } catch (err) {
          console.warn('Failed to parse stored results', err);
        }
      } else {
        updateTeamSummary();
      }

      const storedData = localStorage.getItem('draftData');
      if (storedData) {
        try {
          playersData = JSON.parse(storedData);
          normalizeKeys();
          populatePlayerList(playersData);
          enableSearch();
          updateNominations();
          updateTop200Table();

          const search = document.getElementById('player-search');
          if (search) {
            search.disabled = false;
            search.removeAttribute('disabled');
            search.removeEventListener('input', handleSearch);
            search.addEventListener('input', handleSearch);
          }

          const up = document.getElementById('upload-container');
          if (up) up.style.display = 'none';
        } catch (err) {
          console.warn('Failed to parse stored draft data', err);
        }
      }

      historySetButtons();
    });
  </script>
</body>
</html>