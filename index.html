<!-- Fantasy Draft Tool (CSV-only) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fantasy Draft Tool (CSV)</title>
  <style>
    /* Prevent iOS Safari auto-zoom on inputs */
    input, select, textarea { font-size: 16px; }
    html { -webkit-text-size-adjust: 100%; }
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f9f9f9; }
    header { background-color: #35424a; color: #fff; padding: 1rem; text-align: center; }
    main { max-width: 960px; margin: 0 auto; padding: 1rem; }
    .input-group { margin-bottom: 1rem; }
    .input-group label { display: block; margin-bottom: 0.25rem; font-weight: bold; }
    .input-group input[type="file"], .input-group input[type="text"], .input-group input[type="number"] {
      width: 100%; padding: 0.5rem; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;
    }
    #player-info { border: 1px solid #ddd; padding: 1rem; background-color: #fff; border-radius: 4px; margin-bottom: 1rem; }
    #player-info h2 { margin-top: 0; }
    .info-row { display: flex; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .info-row div { flex: 1 1 50%; margin-bottom: 0.25rem; }
    .results-table { width: 100%; border-collapse: collapse; }
    .results-table th, .results-table td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    .results-table th { background-color: #eaeaea; }
    @media (max-width: 800px) {
      .results-table th, .results-table td { padding: 0.25rem; font-size: 0.8rem; }
      .price-box { padding: 0.25rem; font-size: 0.8rem; }
    }
    button { padding: 0.5rem 1rem; background-color: #35424a; color: #fff; border: none; border-radius: 4px; cursor: pointer; margin-right: 0.5rem; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    @media (max-width: 600px) { .info-row div { flex-basis: 100%; } }

    /* Price boxes styles */
    .price-box-container { display: flex; gap: 0.25rem; margin-bottom: 0.5rem; }
    .price-box { flex: 1; padding: 0.5rem; text-align: center; color: #fff; border-radius: 4px; font-weight: bold; }
    .price-low { background-color: #5cb85c; }
    .price-mid { background-color: #9e9e9e; }
    .price-high { background-color: #d9534f; }

    /* Tier coloring */
    .tier-1 { background-color: #c6efce; }
    .tier-2 { background-color: #dae8fc; }
    .tier-3 { background-color: #fff2cc; }
    .tier-4 { background-color: #f4cccc; }
    .tier-default { background-color: #f3f3f3; }

    /* ===== AI Tag/Notes pills ===== */
    #chip-row { display:flex; align-items:center; gap:8px; }
    #ai-pills { display:none; gap:6px; align-items:center; }
    .ai-pill { display:inline-flex; align-items:center; padding:2px 10px; border-radius:999px; font-weight:700; font-size:0.85rem; color:#fff; max-width:420px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ai-pill.note { background:#666; }
    .ai-pill.rank { background:#424242; padding:2px 8px; }
    @media (max-width:600px){ .ai-pill{ max-width:220px; } }

    /* ===== Tabs ===== */
    #tabbar { display:flex; gap:6px; margin-bottom:10px; }
    .tab-btn { border:1px solid #ccc; background:#fafafa; color:#333; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:700; }
    .tab-btn.active { background:#35424a; color:#fff; border-color:#35424a; }

    /* ===== Top 200 table ===== */
    #top200-section { display:none; }
    #top200-table { width:100%; border-collapse:collapse; background:#fff; border:1px solid #ddd; }
    #top200-table th, #top200-table td { padding:6px; border:1px solid #eee; font-size:0.92rem; }
    #top200-table th { background:#eaeaea; text-align:left; }
    .top200-name { display:flex; align-items:center; gap:8px; }
    .tag-dot { width:10px; height:10px; border-radius:50%; display:inline-block; background:#666; }
    .drafted-row { opacity:0.5; text-decoration:none; }
    .drafted-badge { font-size:0.75rem; font-weight:700; background:#b71c1c; color:#fff; padding:1px 6px; border-radius:10px; }
    #top200-table tbody tr { cursor: pointer; }
    #top200-table tbody tr:hover { background: #f8f8f8; }

    /* Suggested Alternates layout */
    #alternates-box { background: #f5f5f5; border-radius: 4px; margin-top: 0.5rem; padding: 0.5rem; font-size: 0.85rem; }
    @media (max-width: 600px) {
      #player-info { display: flex; flex-wrap: wrap; justify-content: space-between; }
      #basic-info { flex: 1; }
      #alternates-box { flex: 1; text-align: right; }
    }
  </style>
</head>
<body>
  <main>
        <div id="tabbar">
      <button id="tab-inputs" class="tab-btn active">Inputs</button>
      <button id="tab-top200" class="tab-btn">Top 200</button>
    </div>

        <div id="inputs-section">
      <div class="input-group" id="upload-container">
        <label for="csv-file">Upload CSV (downloaded from your sheet)</label>
        <input type="file" id="csv-file" accept=".csv"/>
      </div>

      <div class="input-group">
        <label for="player-search">Search for a player</label>
        <input type="text" id="player-search" placeholder="Start typing player name..." list="players-list" autocomplete="off" disabled />
        <datalist id="players-list"></datalist>
      </div>

            <div id="nominations-box" style="display:none; margin-top:1rem; padding:0.5rem; background:#fff; border:1px solid #ddd; border-radius:4px;">
        <h3>Suggested Nominations</h3>
        <ul id="nominations-list" style="list-style:none; padding-left:0; margin:0;"></ul>
      </div>

            <div id="player-info" style="margin-top:20px; display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 id="player-name" style="margin:0;"></h2>
          <div id="chip-row">
            <div id="inflation-chip" style="display:none; margin-left:1rem; padding:2px 8px; border-radius:12px; font-weight:bold; font-size:0.9rem; background:#eee; color:#333;"></div>
            <div id="ai-pills" style="display:none;"></div>
          </div>
        </div>

        <div style="display:flex; flex-wrap:wrap; justify-content:space-between; margin-top:0.5rem;">
          <div style="flex:1; min-width:120px;">
            <div class="info-row" id="basic-info"></div>
            <p id="player-position"></p>
            <p id="player-team"></p>
            <p id="player-values"></p>
          </div>
          <div style="flex:1; min-width:240px; text-align:right;">
            <div id="alternates-box" style="display:none; font-size:0.85rem;"></div>
          </div>
        </div>
      </div>

            <div id="bid-form" style="display:none; margin-bottom:1rem;">
        <div class="input-group">
          <label for="winning-bid">Winning bid ($)</label>
          <input type="text" id="winning-bid" inputmode="numeric" pattern="[0-9]*" autocomplete="off" enterkeyhint="done" aria-label="Winning bid in dollars">
        </div>
        <div class="input-group">
          <label for="winning-team-select">Winning team</label>
          <select id="winning-team-select"></select>
        </div>
        <button id="add-result" disabled>Add to Results</button>
      </div>

      <div class="info-row" id="auction-info"></div>
      <div class="info-row" id="metrics-info"></div>

            <div id="price-section" style="display:none; margin-top:1rem;">
        <h3>Auction Value</h3>
        <div class="price-box-container">
          <div class="price-box price-low" id="aav-min"></div>
          <div class="price-box price-mid" id="aav-mid"></div>
          <div class="price-box price-high" id="aav-max"></div>
        </div>
        <h3>VBD Value</h3>
        <div class="price-box-container">
          <div class="price-box price-low" id="vbd-min"></div>
          <div class="price-box price-mid" id="vbd-mid"></div>
          <div class="price-box price-high" id="vbd-max"></div>
        </div>
      </div>

            <div id="avail-table-section" style="display:none; margin-top:1rem;">
        <h3>Players still avail at <span id="pos-label"></span></h3>
        <table class="results-table" id="avail-table">
          <thead>
            <tr><th>#</th><th>Name</th><th>Tier</th><th>Pos Rank</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

            <div id="rankings-table-section" style="display:none; margin-top:1rem;">
        <h3><span id="pos-rank-label"></span> Rankings and Tiers</h3>
        <table class="results-table" id="rankings-table">
          <thead>
            <tr><th>Pos Rank</th><th>Name</th><th>Tier</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>         <section id="top200-section">
      <h2>Top 200 Board</h2>

      <div style="margin:6px 0 10px 0; font-size:0.9rem;">
        <span class="ai-pill rank">R#</span>
        <span class="ai-pill" style="background:#3498DB">Value if Slips</span>
        <span class="ai-pill" style="background:#9B59B6">Darkhorse League Winner</span>
        <span class="ai-pill" style="background:#2ECC71">Auction Value Anchor</span>
        <span class="ai-pill" style="background:#FFD700; color:#333">True Anchor</span>
        <span class="ai-pill" style="background:#1ABC9C">Coaching/Role Boost</span>
        <span class="ai-pill" style="background:#F39C12">Injury Risk</span>
        <span class="ai-pill" style="background:#E74C3C">Context Fade</span>
      </div>

      <div id="top200-controls" style="display:flex; gap:8px; align-items:center; margin:6px 0 10px 0;">
        <input id="top200-filter" type="text" placeholder="Filter name/team/tag/notes…" style="flex:1; padding:6px 8px; border:1px solid #ccc; border-radius:6px;">
        <label style="display:flex; gap:6px; align-items:center; font-size:0.9rem;">
          <input id="top200-hide-drafted" type="checkbox"> Hide drafted
        </label>
      </div>

      <table id="top200-table">
        <thead>
          <tr>
            <th style="width:56px;">Rank</th>
            <th>Name</th>
            <th style="width:70px;">Pos</th>
            <th style="width:80px;">Team</th>
            <th style="width:180px;">Tag</th>
            <th>Notes</th>
            <th style="width:90px;">Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script>
    // ---------- Helpers ----------
    function num(val){
      if (val===undefined||val===null||val==='') return 0;
      const n=parseFloat(String(val).replace(/[^0-9.\\-]/g,''));
      return isNaN(n)?0:n;
    }
    function tierOf(p){ const t=num(p['Tier']); return t>0?t:99; }
    function getRowByName(name){ return playersData.find(p => (p['Name']||p['Player'])===name); }
    function draftedSet(){ const s=new Set(); results.forEach(r=>s.add(r.player)); return s; }
    function getVBD(p){
      const v = num(p['VBD'] || p['VBD Points']); return Number.isFinite(v) ? v : 0;
    }
    function sanitize(str){ return (str == null) ? '' : String(str).replace(/\s+/g, ' ').trim(); }
    function getField(obj, candidates) { for (const k of candidates) { if (obj[k] != null && String(obj[k]).trim() !== '') return obj[k]; } return ''; }
    function htmlEsc(s){ return (s == null) ? '' : String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    function renderAiPills(player){
      const wrap = document.getElementById('ai-pills'); if (!wrap) return;
      const tag = sanitize(getField(player, ['Tag','tag','AI Tag','Ai Tag','AI_Tag']));
      const note = sanitize(getField(player, ['Notes','Note','notes']));
      const hex = sanitize(getField(player, ['TagColor','Tag Color','tagcolor'])) || '#666';
      const rankText = sanitize(getField(player, ['Rank','rank']));
      if (!tag){ wrap.style.display = 'none'; wrap.innerHTML = ''; return; }

      const noteBg = /^#[0-9a-f]{6}$/i.test(hex) ? (hex + 'CC') : '#666';
      const rankPill = rankText ? `<span class="ai-pill rank" title="Overall Rank">${String(rankText).startsWith('R') ? rankText : 'R'+rankText}</span>` : '';
      const tagPill  = `<span class="ai-pill" style="background:${hex}" title="${note || tag}">${tag}</span>`;
      const notePill = note ? `<span class="ai-pill note" style="background:${noteBg}" title="${note}">${note}</span>` : '';
      wrap.innerHTML = `${rankPill}${tagPill}${notePill}`;
      wrap.style.display = 'inline-flex';
    }

    // ---- Top 200 helpers/render ----
    function getRankNum(row){ return num(row['Rank']); }
    function tagColor(row){ const c=(row['TagColor']||'').toString().trim(); return /^#[0-9a-f]{6}$/i.test(c)?c:'#666'; }
    function tagText(row){ return (row['Tag']||'').toString().trim(); }
    function isTop200Row(row){ const r=getRankNum(row); const hasTag=tagText(row).length>0; return (r>0&&r<=200)||hasTag; }

    function updateTop200Table(){
      const table = document.getElementById('top200-table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      if (!playersData || !playersData.length){ tbody.innerHTML = ''; return; }

      const drafted = draftedSet();
      const q = (document.getElementById('top200-filter')?.value || '').toLowerCase();
      const hideDrafted = !!document.getElementById('top200-hide-drafted')?.checked;

      const rows = playersData
        .filter((r)=>{
          if (!isTop200Row(r)) return false;
          const nm = r['Name'] || r['Player'] || '';
          if (hideDrafted && drafted.has(nm)) return false;
          if (!q) return true;
          const hay = `${nm} ${(r['Team']||'')} ${(r['Pos.']||'')} ${tagText(r)} ${(r['Notes']||'')}`.toLowerCase();
          return hay.includes(q);
        })
        .slice()
        .sort((a,b)=>{
          const ra = getRankNum(a), rb = getRankNum(b);
          if (ra && rb) return ra - rb;
          if (ra) return -1;
          if (rb) return 1;
          return num(b['VBD$']) - num(a['VBD$']) || ((a['Name']||'').localeCompare(b['Name']||''));
        });

      tbody.innerHTML = '';
      for (const row of rows){
        const rnk = getRankNum(row);
        const name = row['Name'] || row['Player'] || '';
        const pos = row['Pos.'] || '';
        const team = row['Team'] || '';
        const tag = tagText(row);
        const col = tagColor(row);
        const note = (row['Notes'] || '').toString().trim();
        const isDrafted = drafted.has(name);
        const tr = document.createElement('tr');
        tr.dataset.player = name;
        if (isDrafted) tr.classList.add('drafted-row');
        tr.innerHTML = `
          <td>${rnk ? 'R'+rnk : ''}</td>
          <td>
            <div class="top200-name">
              <span class="tag-dot" style="background:${col}"></span>
              ${htmlEsc(name)}
            </div>
          </td>
          <td>${htmlEsc(pos)}</td>
          <td>${htmlEsc(team)}</td>
          <td>
            ${tag ? `<span class="ai-pill" style="background:${col}" title="${htmlEsc(tag)}">${htmlEsc(tag)}</span>` : ''}
          </td>
          <td>${htmlEsc(note)}</td>
          <td>${isDrafted ? '<span class="drafted-badge">Drafted</span>' : ''}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function showTab(which){
      const inputs = document.getElementById('inputs-section');
      const top200 = document.getElementById('top200-section');
      const bInputs = document.getElementById('tab-inputs');
      const bTop = document.getElementById('tab-top200');
      if (!inputs || !top200 || !bInputs || !bTop) return;
      localStorage.setItem('activeTab', which);
      if (which === 'top'){
        inputs.style.display = 'none'; top200.style.display = ''; bTop.classList.add('active'); bInputs.classList.remove('active');
        updateTop200Table();
      } else {
        inputs.style.display = ''; top200.style.display = 'none'; bInputs.classList.add('active'); bTop.classList.remove('active');
      }
    }

    // ---------- Undo/Redo (history) ----------
    const HISTORY_LIMIT = 200;
    const history = { past: [], future: [] };
    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }
    function currentSnapshot(meta){
      return { at: Date.now(), meta: meta || null, results: deepClone(results), teamStatus: deepClone(teamStatus) };
    }
    function historySetButtons(){
      const u = document.getElementById('undo-last'); const r = document.getElementById('redo-last');
      if (u) u.disabled = history.past.length === 0;
      if (r) r.disabled = history.future.length === 0;
    }
    function historyCommit(meta){
      history.past.push(currentSnapshot(meta));
      if (history.past.length > HISTORY_LIMIT) history.past.shift();
      history.future = [];
      historySetButtons();
    }
    function applySnapshot(snap){
      results = deepClone(snap.results); teamStatus = deepClone(snap.teamStatus);
      localStorage.setItem('draftResults', JSON.stringify(results));
      localStorage.setItem('teamStatus', JSON.stringify(teamStatus));
      updateResultsTable(); updateTeamSummary(); updateInflationChip(selectedPlayer); updateNominations(); updateTop200Table();
    }
    function undo(){
      if (history.past.length === 0) return;
      const now = currentSnapshot({ type: 'UNDO-SAVE' }); history.future.unshift(now);
      const prev = history.past.pop(); applySnapshot(prev); historySetButtons();
    }
    function redo(){
      if (history.future.length === 0) return;
      history.past.push(currentSnapshot({ type: 'REDO-SAVE' }));
      const next = history.future.shift(); applySnapshot(next); historySetButtons();
    }
    window.addEventListener('keydown', (e)=>{
      const zKey = e.key && e.key.toLowerCase() === 'z'; const mod = e.metaKey || e.ctrlKey;
      if (!mod || !zKey) return;
      const el = document.activeElement; const tag = (el && el.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea' || (el && el.isContentEditable)) return;
      if (e.shiftKey){ if (history.future.length){ e.preventDefault(); redo(); } }
      else { if (history.past.length){ e.preventDefault(); undo(); } }
    });

    // ---------- Teams / Draft state ----------
    let playersData = [];
    let results = [];
    let selectedPlayer = null;

    const TEAM_PRESETS = {
      A: [
        { name: 'Vinny', startingBudget: 200, rosterSize: 16 },
        { name: 'Wax', startingBudget: 200, rosterSize: 16 },
        { name: 'Jody', startingBudget: 200, rosterSize: 16 },
        { name: 'Migs', startingBudget: 200, rosterSize: 16 },
        { name: 'Nick', startingBudget: 200, rosterSize: 16 },
        { name: 'Jew',  startingBudget: 200, rosterSize: 16 },
        { name: 'Joey', startingBudget: 200, rosterSize: 16 },
        { name: 'Matt', startingBudget: 200, rosterSize: 16 },
        { name: 'Art',  startingBudget: 200, rosterSize: 16 },
        { name: 'Manning', startingBudget: 200, rosterSize: 16 },
        { name: 'Clegg', startingBudget: 200, rosterSize: 16 },
        { name: 'BG',   startingBudget: 200, rosterSize: 16 }
      ],
      B: [
        { name: 'Vinny', startingBudget: 200, rosterSize: 16 },
        { name: 'Corey', startingBudget: 200, rosterSize: 16 },
        { name: 'Elvin', startingBudget: 200, rosterSize: 16 },
        { name: 'Nick', startingBudget: 200, rosterSize: 16 },
        { name: 'Art', startingBudget: 200, rosterSize: 16 },
        { name: 'Tyler', startingBudget: 200, rosterSize: 16 },
        { name: 'Sae', startingBudget: 200, rosterSize: 16 },
        { name: 'Ron', startingBudget: 200, rosterSize: 16 },
        { name: 'Torch', startingBudget: 200, rosterSize: 16 },
        { name: 'Butch', startingBudget: 200, rosterSize: 16 },
        { name: 'Kyree', startingBudget: 200, rosterSize: 16 },
        { name: 'Shacor', startingBudget: 200, rosterSize: 16 }
      ],
      C: [
        { name: 'Vinny', startingBudget: 200, rosterSize: 16 },
        { name: 'Schmidt', startingBudget: 200, rosterSize: 16 },
        { name: 'Corey', startingBudget: 200, rosterSize: 16 },
        { name: 'Corc', startingBudget: 200, rosterSize: 16 },
        { name: 'Nick', startingBudget: 200, rosterSize: 16 },
        { name: 'Hatz', startingBudget: 200, rosterSize: 16 },
        { name: 'Barber', startingBudget: 200, rosterSize: 16 },
        { name: 'Elvin', startingBudget: 200, rosterSize: 16 },
        { name: 'Carlos', startingBudget: 200, rosterSize: 16 },
        { name: 'Ron', startingBudget: 200, rosterSize: 16 },
        { name: 'Art', startingBudget: 200, rosterSize: 16 },
        { name: 'RL', startingBudget: 200, rosterSize: 16 }
      ]
    };
    const urlDraft = new URLSearchParams(location.search).get('draft');
    const ACTIVE_DRAFT = (urlDraft && TEAM_PRESETS[urlDraft.toUpperCase()]) ? urlDraft.toUpperCase() : 'A';
    const teams = TEAM_PRESETS[ACTIVE_DRAFT];

    let teamStatus = {};
    function initTeamData() {
      const savedStatus = localStorage.getItem('teamStatus');
      if (savedStatus) { try { teamStatus = JSON.parse(savedStatus); } catch { teamStatus = {}; } }
      teams.forEach(team => {
        if (!teamStatus[team.name]) {
          teamStatus[team.name] = { remaining: team.startingBudget, picks: 0, rosterSize: team.rosterSize };
        }
      });
      const teamSelect = document.getElementById('winning-team-select');
      if (teamSelect){
        teamSelect.innerHTML = '<option value="">--Select--</option>';
        teams.forEach(team => {
          const opt = document.createElement('option'); opt.value = team.name; opt.textContent = team.name; teamSelect.appendChild(opt);
        });
      }
      updateTeamSummary();
    }
    function updateTeamSummary() {
      const table = document.getElementById('team-summary-table');
      if (!table) { localStorage.setItem('teamStatus', JSON.stringify(teamStatus)); return; }
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      teams.forEach(team => {
        const status = teamStatus[team.name];
        const slotsLeft = status.rosterSize - status.picks;
        const maxBid = slotsLeft > 0 ? (status.remaining - (slotsLeft - 1)) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${team.name}</td><td>$${status.remaining.toFixed(0)}</td><td>$${maxBid.toFixed(0)}</td><td>${status.picks}</td>`;
        tbody.appendChild(tr);
      });
      localStorage.setItem('teamStatus', JSON.stringify(teamStatus));
    }

function parseCSV(text) {
  if (!text) return [];

  // 1) Normalize and strip BOM + Excel's "sep=" noise
  text = String(text).replace(/^\uFEFF/, '');
  let lines = text.split(/\r?\n/);
  lines = lines.filter((ln, i) => !(i < 3 && /^sep\s*=/.test(ln.trim().toLowerCase())));

  // 2) Split a row by delimiter, respecting quotes (escape the delimiter!)
  function esc(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
  function splitRow(row, delim) {
    const re = new RegExp(esc(delim) + '(?=(?:[^"]*"[^"]*")*[^"]*$)');
    return row.split(re).map(c => c.replace(/^"|"$/g, '').trim());
  }

  // 3) Auto-detect header & delimiter (look for a Name/Player column)
  const cands = [',',';','\t','|'];
  const nonEmpty = lines.filter(l => l.trim().length);
  if (!nonEmpty.length) return [];

  let headerIdx = -1, delim = ',', headers = [];
  for (let i = 0; i < Math.min(nonEmpty.length, 25) && headerIdx === -1; i++) {
    for (const d of cands) {
      const cols = splitRow(nonEmpty[i], d);
      if (cols.some(h => /(name|player)/i.test(h))) {
        headerIdx = lines.indexOf(nonEmpty[i]);
        delim = d;
        headers = cols;
        break;
      }
    }
  }

  // Fallback: densest delimiter on the first real line
  if (headerIdx === -1) {
    delim = cands.reduce((best, d) => {
      // FIX: Correctly escape backslash in regex for special characters like '\t'
      const dRegex = d === '\t' ? '\t' : esc(d);
      const cnt = (nonEmpty[0].match(new RegExp(dRegex, 'g')) || []).length;
      const bestRegex = best === '\t' ? '\t' : esc(best);
      const bestCnt = (nonEmpty[0].match(new RegExp(bestRegex, 'g')) || []).length;
      return cnt > bestCnt ? d : best;
    }, ',');
    headers = splitRow(nonEmpty[0], delim);
    headerIdx = lines.indexOf(nonEmpty[0]);
  }
  if (!headers.length) return [];

  // 4) Identify the name column
  const nameKey = headers.find(h => /(name|player)/i.test(h)) || headers[0];

  // 5) Build rows (start right after header) and keep only those with a name
  const out = [];
  for (let i = headerIdx + 1; i < lines.length; i++) {
    const L = lines[i];
    if (!L || !L.trim()) continue;

    const cols = splitRow(L, delim);
    if (cols.length === 1 && cols[0] === '') continue; // empty junk rows

    const obj = {};
    headers.forEach((h, idx) => { obj[h] = (cols[idx] ?? '').replace(/^"|"$/g, '').trim(); });

    const nm = (obj[nameKey] || '').trim();
    if (!nm) continue;                 // ignore non-player rows (totals, blank, etc.)
    if (!obj['Name']) obj['Name'] = nm; // canonicalize

    out.push(obj);
  }

  // Breadcrumb for sanity checks in DevTools
  console.log('[CSV]', { rows: out.length, nameKey, sample: out.slice(0, 3).map(r => r.Name) });
  return out;
}


    // ---------- Availability / Value helpers ----------
    function availByPos(pos){
      const d = draftedSet();
      return playersData.filter(p => (p['Pos.']===pos) && (p['Name']||p['Player']) && !d.has(p['Name']||p['Player']));
    }
    function countsByTeam(){
      const map = {}; teams.forEach(t => map[t.name] = {QB:0,RB:0,WR:0,TE:0});
      results.forEach(r => {
        const row = getRowByName(r.player); if (!row) return;
        const pos = row['Pos.']; const team = r.team;
        if (!map[team]) map[team] = {QB:0,RB:0,WR:0,TE:0};
        if (pos==='QB'||pos==='RB'||pos==='WR'||pos==='TE') map[team][pos] += 1;
      });
      return map;
    }
    function starterNeeds(){
      const c = countsByTeam();
      const needs = {};
      teams.forEach(t => {
        const ct = c[t.name] || {QB:0,RB:0,WR:0,TE:0};
        const needQB = Math.max(0, 1 - ct.QB);
        const needRB = Math.max(0, 2 - ct.RB);
        const needWR = Math.max(0, 2 - ct.WR);
        const needTE = Math.max(0, 1 - ct.TE);
        const overflow = Math.max(0, ct.RB-2) + Math.max(0, ct.WR-2) + Math.max(0, ct.TE-1);
        const needFLEX = Math.max(0, 2 - overflow);
        needs[t.name] = {needQB, needRB, needWR, needTE, needFLEX};
      });
      return needs;
    }
    function valueDelta(row){
      const v = num(row['VMID'] || row['MID'] || row['VBD$']);
      const a = num(row['Average Auction Value']); return v - a;
    }
    function scarcityByPos(needs){
      const s = {QB:0,RB:0,WR:0,TE:0, flexRB:0, flexWR:0, flexTE:0};
      teams.forEach(t=>{
        const n = needs[t.name]; if (!n) return;
        if (n.needQB>0) s.QB++; if (n.needRB>0) s.RB++; if (n.needWR>0) s.WR++; if (n.needTE>0) s.TE++;
        if (n.needFLEX>0){ s.flexRB++; s.flexWR++; s.flexTE++; }
      });
      return s;
    }
    function pickCliffCandidate(pos){
      const list = availByPos(pos).slice().sort((a,b)=> tierOf(a)-tierOf(b) || num(a['Pos. Rank'])-num(b['Pos. Rank']));
      if (!list.length) return null;
      const topTier = tierOf(list[0]);
      const sameTier = list.filter(p=>tierOf(p)===topTier);
      if (sameTier.length===1) return {row:sameTier[0], reason:`Last in Tier ${topTier}`, tag:'cliff'};
      return {row:sameTier[sameTier.length-1], reason:`Tier ${topTier} near cliff`, tag:'near'};
    }
    function pickValueForVinny(needs){
      const vinnyName = (teams.find(t=>/vinny/i.test(t.name))?.name) || teams[0]?.name; if (!vinnyName) return [];
      const n = needs[vinnyName]; const wants = [];
      if (n.needQB>0) wants.push('QB');
      if (n.needRB>0 || n.needFLEX>0) wants.push('RB');
      if (n.needWR>0 || n.needFLEX>0) wants.push('WR');
      if (n.needTE>0 || n.needFLEX>0) wants.push('TE');
      const seen = new Set(), picks=[];
      wants.forEach(pos=>{
        const list = availByPos(pos).slice().sort((a,b)=> valueDelta(b)-valueDelta(a) || tierOf(a)-tierOf(b));
        for (const row of list){
          const name = row['Name']||row['Player'];
          if (!seen.has(name)){
            seen.add(name);
            picks.push({row, reason:`Value for ${vinnyName}: VBD–AAV +$${Math.max(0,valueDelta(row)).toFixed(0)}`, tag:'scarce'});
            break;
          }
        }
      });
      return picks.slice(0,2);
    }

    // ---------- Inflation chip ----------
    function computeInflationByPos() {
      const byPos = {};
      results.forEach(r => {
        const row = playersData.find(p => (p['Name'] || p['Player']) === r.player);
        if (!row) return;
        const pos = row['Pos.'];
        const aav = parseFloat((row['Average Auction Value'] || '').toString().replace(/\$/g, '')) || 0;
        const bid = parseFloat(r.bid) || 0;
        if (!byPos[pos]) byPos[pos] = { sumBid: 0, sumAav: 0, n: 0 };
        byPos[pos].sumBid += bid; byPos[pos].sumAav += aav; byPos[pos].n += 1;
      });
      const infl = {};
      Object.keys(byPos).forEach(pos => {
        const d = byPos[pos];
        if (d.sumAav > 0 && d.n >= 3) { infl[pos] = d.sumBid / d.sumAav - 1; }
      });
      return infl;
    }
    function inflationLabelAndStyle(f) {
      if (f <= -0.15) return { text: 'Strong Buy', bg: '#2e7d32', color: '#fff' };
      if (f <= -0.05) return { text: 'Buy', bg: '#43a047', color: '#fff' };
      if (f < 0.05) return { text: 'Hold', bg: '#9e9e9e', color: '#fff' };
      if (f < 0.15) return { text: 'Caution', bg: '#f57c00', color: '#fff' };
      return { text: 'Strong Hold', bg: '#c62828', color: '#fff' };
    }
    function updateInflationChip(selected) {
      const chip = document.getElementById('inflation-chip'); if (!chip) return;
      if (!selected || playersData.length === 0) { chip.style.display = 'none'; return; }
      const pos = selected['Pos.']; const posInfl = computeInflationByPos()[pos];
      if (posInfl === undefined) {
        chip.textContent = 'Market: N/A'; chip.style.background = '#e0e0e0'; chip.style.color = '#333'; chip.style.display = ''; return;
      }
      const { text, bg, color } = inflationLabelAndStyle(posInfl);
      chip.textContent = `${text} (${Math.round(posInfl * 100)}%)`; chip.style.background = bg; chip.style.color = color; chip.style.display = '';
    }

    // ---------- Nominations ----------
    function updateNominations(){
      const box = document.getElementById('nominations-box'); const list = document.getElementById('nominations-list');
      if (!box || !list) return;
      list.innerHTML=''; box.style.display='none';
      if (!playersData.length || selectedPlayer){ return; }
      try{
        const needs = starterNeeds(); const scarcity = scarcityByPos(needs);
        const order = ['WR','RB','TE','QB'].slice().sort((a,b)=>{
          const wa = (scarcity[a]||0)*2 + (scarcity['flex'+a]||0);
          const wb = (scarcity[b]||0)*2 + (scarcity['flex'+b]||0);
          return wb - wa;
        });

        const chosen = []; const chosenNames = new Set();

        for (const pos of order){
          const cand = pickCliffCandidate(pos);
          if (cand){
            const nm = cand.row['Name']||cand.row['Player'];
            if (!chosenNames.has(nm)){
              const needStart = scarcity[pos]||0; const needFlex = scarcity['flex'+pos]||0;
              chosen.push({
                row:cand.row,
                reason:`${cand.reason} — ${needStart} teams still need ${pos} starters${needFlex? ' (+'+needFlex+' flex)':''}`,
                tag:cand.tag
              });
              chosenNames.add(nm);
            }
        }
        const valuePicks = pickValueForVinny(needs);
        for (const pick of valuePicks){
          const nm = pick.row['Name']||pick.row['Player'];
          if (!chosenNames.has(nm)){ chosen.push(pick); chosenNames.add(nm); }
        }
        chosen.sort((a,b)=>num(a.row['Rank'])-num(b.row['Rank']));
        
        for (const c of chosen){
          const name = c.row['Name'] || c.row['Player'] || '';
          if (!name) continue;
          const pos = c.row['Pos.']||'';
          const li = document.createElement('li');
          li.innerHTML = `<a href="#player-info" onclick="selectPlayer('${htmlEsc(name)}');">${htmlEsc(name)}</a> (${htmlEsc(pos)}) - ${htmlEsc(c.reason)}`;
          list.appendChild(li);
        }
        
        if (chosen.length > 0){ box.style.display = 'block'; }
      } catch(e){ console.error('Error updating nominations:', e); }
    }


    // ---------- Main Player search/selection logic ----------
    function findPlayer(query) {
      if (!playersData.length) return null;
      const name = (query || '').toLowerCase().trim();
      const exact = playersData.find(p => (p['Name'] || p['Player'])?.toLowerCase().trim() === name);
      if (exact) return exact;
      return playersData.find(p => (p['Name'] || p['Player'])?.toLowerCase().includes(name));
    }

    function clearPlayerInfo() {
      selectedPlayer = null;
      document.getElementById('player-info').style.display = 'none';
      document.getElementById('price-section').style.display = 'none';
      document.getElementById('avail-table-section').style.display = 'none';
      document.getElementById('rankings-table-section').style.display = 'none';
      document.getElementById('bid-form').style.display = 'none';
      document.getElementById('player-search').value = '';
      updateNominations();
    }

    function updatePlayerInfo(player) {
      selectedPlayer = player;
      if (!player) { clearPlayerInfo(); return; }
      
      const isDrafted = draftedSet().has(player['Name']||player['Player']);

      // Display basic info
      document.getElementById('player-info').style.display = 'block';
      document.getElementById('player-name').textContent = player['Name'] || player['Player'] || 'Unknown Player';
      document.getElementById('player-position').innerHTML = `<strong>Position:</strong> ${htmlEsc(player['Pos.']||'')}`;
      document.getElementById('player-team').innerHTML = `<strong>Team:</strong> ${htmlEsc(player['Team']||'')}`;
      
      // Display values and price boxes
      const vbdVal = num(getField(player, ['VBD Value', 'VBD', 'VBD Points']));
      const aavVal = num(getField(player, ['Auction Value', 'AAV', 'Average Auction Value']));
      document.getElementById('player-values').innerHTML = `<strong>VBD Value:</strong> $${vbdVal.toFixed(0)} | <strong>AAV:</strong> $${aavVal.toFixed(0)}`;
      
      const priceSection = document.getElementById('price-section');
      priceSection.style.display = 'block';
      document.getElementById('aav-min').textContent = `$${Math.max(0, aavVal-5).toFixed(0)}`;
      document.getElementById('aav-mid').textContent = `$${aavVal.toFixed(0)}`;
      document.getElementById('aav-max').textContent = `$${(aavVal+5).toFixed(0)}`;
      document.getElementById('vbd-min').textContent = `$${Math.max(0, vbdVal-5).toFixed(0)}`;
      document.getElementById('vbd-mid').textContent = `$${vbdVal.toFixed(0)}`;
      document.getElementById('vbd-max').textContent = `$${(vbdVal+5).toFixed(0)}`;

      // Tier
      const tier = tierOf(player);
      const tierEl = document.getElementById('tier-info');
      if (tierEl) tierEl.textContent = `Tier: ${tier === 99 ? 'N/A' : tier}`;

      // Bid form
      const bidForm = document.getElementById('bid-form');
      const addBtn = document.getElementById('add-result');
      const bidInput = document.getElementById('winning-bid');
      bidForm.style.display = isDrafted ? 'none' : 'block';
      addBtn.disabled = true;
      bidInput.value = '';
      
      // Show available players at this position
      const pos = player['Pos.'];
      const avail = availByPos(pos).filter(p => p['Name'] !== player['Name']).sort((a,b)=> tierOf(a)-tierOf(b) || num(a['Pos. Rank'])-num(b['Pos. Rank']));
      
      const availTableSection = document.getElementById('avail-table-section');
      const availTableBody = document.getElementById('avail-table').querySelector('tbody');
      document.getElementById('pos-label').textContent = pos;
      availTableBody.innerHTML = '';
      if(avail.length){
        availTableSection.style.display = 'block';
        avail.slice(0,10).forEach((p,i)=>{
          const tr = document.createElement('tr');
          tr.dataset.player = p['Name']||p['Player'];
          tr.className = `tier-${tierOf(p)}`;
          tr.innerHTML = `<td>${i+1}</td><td>${htmlEsc(p['Name']||p['Player'])}</td><td>${tierOf(p)}</td><td>${htmlEsc(p['Pos. Rank']||'')}</td>`;
          availTableBody.appendChild(tr);
        });
      } else {
        availTableSection.style.display = 'none';
      }

      // Alternate/Rankings
      const altBox = document.getElementById('alternates-box');
      const vbdAvail = avail.slice().sort((a,b) => getVBD(b)-getVBD(a));
      if (vbdAvail.length){
        altBox.style.display = 'block';
        const topVBD = vbdAvail[0];
        altBox.innerHTML = `<strong>Best alternate:</strong><br><a href="#" onclick="selectPlayer('${htmlEsc(topVBD['Name']||topVBD['Player'])}');">${htmlEsc(topVBD['Name']||topVBD['Player'])}</a> ($${getVBD(topVBD).toFixed(0)})`;
      } else {
        altBox.style.display = 'none';
      }
      
      renderAiPills(player);
      updateInflationChip(player);
      updateNominations();
    }

    function updateResultsTable(){
      const table = document.getElementById('results-table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      results.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.player}</td><td>$${r.bid}</td><td>${r.team}</td>`;
        tbody.appendChild(tr);
      });
    }

    function selectPlayer(name){
      const player = getRowByName(name);
      if (player){
        updatePlayerInfo(player);
      } else {
        clearPlayerInfo();
      }
    }

    // ---------- Event Listeners ----------
    document.addEventListener('DOMContentLoaded', () => {
      initTeamData();
      
      // Tab switching
      const savedTab = localStorage.getItem('activeTab');
      showTab(savedTab === 'top' ? 'top' : 'inputs');
      
      document.getElementById('tab-inputs').addEventListener('click', () => showTab('inputs'));
      document.getElementById('tab-top200').addEventListener('click', () => showTab('top'));
      
      // CSV file upload
      document.getElementById('csv-file').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          playersData = parseCSV(event.target.result);
          document.getElementById('player-search').disabled = false;
          
          const datalist = document.getElementById('players-list');
          datalist.innerHTML = '';
          playersData.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p['Name'] || p['Player'];
            datalist.appendChild(opt);
          });
          
          // Clear and reset
          clearPlayerInfo();
          updateNominations();
          updateTop200Table();
        };
        reader.readAsText(file);
      });

      // Player search
      document.getElementById('player-search').addEventListener('input', (e) => {
        const query = e.target.value.trim();
        if (query.length > 2) {
          const player = findPlayer(query);
          if (player) {
            updatePlayerInfo(player);
          } else {
            clearPlayerInfo();
          }
        } else {
          clearPlayerInfo();
        }
      });
      
      document.getElementById('winning-bid').addEventListener('input', (e)=>{
        const bid = num(e.target.value);
        const team = document.getElementById('winning-team-select').value;
        const addBtn = document.getElementById('add-result');
        addBtn.disabled = !(bid > 0 && team && selectedPlayer);
      });
      
      document.getElementById('winning-team-select').addEventListener('change', (e)=>{
        const bid = num(document.getElementById('winning-bid').value);
        const team = e.target.value;
        const addBtn = document.getElementById('add-result');
        addBtn.disabled = !(bid > 0 && team && selectedPlayer);
      });

      document.getElementById('add-result').addEventListener('click', () => {
        const player = selectedPlayer['Name'] || selectedPlayer['Player'];
        const bid = num(document.getElementById('winning-bid').value);
        const team = document.getElementById('winning-team-select').value;
        
        if (player && bid > 0 && team) {
          // Update team status
          teamStatus[team].remaining -= bid;
          teamStatus[team].picks += 1;
          
          // Add to results
          results.push({ player, bid, team });
          
          // Commit state and update UI
          historyCommit({type:'DRAFT', player, bid, team});
          updateTeamSummary();
          updateResultsTable();
          clearPlayerInfo();
          updateTop200Table();
        }
      });
      
      // Attach a single listener for dynamic elements
      document.body.addEventListener('click', (e)=>{
        const target = e.target.closest('#avail-table tbody tr, #top200-table tbody tr');
        if (target && target.dataset.player){
          e.preventDefault();
          selectPlayer(target.dataset.player);
          document.getElementById('player-search').value = target.dataset.player;
          showTab('inputs');
        }
      });
      
      // Update top 200 table on filter/checkbox change
      const top200Filter = document.getElementById('top200-filter');
      const top200HideDrafted = document.getElementById('top200-hide-drafted');
      if (top200Filter) top200Filter.addEventListener('input', updateTop200Table);
      if (top200HideDrafted) top200HideDrafted.addEventListener('change', updateTop200Table);
      
    });
    
  </script>
</body>
</html>
